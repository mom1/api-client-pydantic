# -*- coding: utf-8; mode: python -*-
import emoji


ignore_regexps = [
    r'(ğŸ”€|:twisted_rightwards_arrows:|[Mm]erge)',
    r'(âª|:rewind:|[Rr]evert)',
    r'(ğŸš¨|:rotating_light:)',
    r'(ğŸš§|:construction:)',
    r'(ğŸ’š|:green_heart:)',
    r'(ğŸ“|:memo:)\s*(Update CHANGELOG\.md)',
]

section_regexps = [
    ('New âœ¨', [
        r"""(?x)^([nN]ew:?|[Ff]eat:?|
          âœ¨|:sparkles:
        )\s*([^\n]*)$""",
    ]),
    ('Changes â™»ï¸', [
        r"""(?x)^([cC]hg:?
          |ğŸ—ƒ|:card_file_box:
          |âœï¸|:pencil[2]?:
          |ğŸ”¥|:fire:
          |âš¡ï¸|:zap:
          |ğŸ¨|:art:
          |ğŸ‘½|:alien:
          |ğŸ’¥|:boom:
          |ğŸ”§|:wrench:
          |ğŸ·ï¸|:label:
          |â™»ï¸|:recycle:
          |ğŸš¸|:children_crossing:
          )\s*([^\n]*)$""",
    ]),
    ('Bugs ğŸ›', [
        r"""(?x)^([fF]ix:?
          |ğŸ›|:bug:
        )\s*([^\n]*)$""",
    ]),
    ('Dependencies â¬†ï¸', [
        r"""(?x)^(
          â¬†ï¸|:arrow_up:|
          â¬‡ï¸|:arrow_down:|
          â•|:heavy_plus_sign:|
          â–|:heavy_minus_sign:|
          ğŸ“Œ|:pushpin:
        )\s*([^\n]*)$""",
    ]),
    ('Documentation ğŸ“', [r'^(ğŸ“|:memo:)\s*([^\n]*)$']),
    ('Other ğŸŒ±', None),  # Match all lines
]

body_process = ReSub(r'((^|\n)[A-Z]\w+(-\w+)*: .*(\n\s+.*)*)+$', r'') | strip

subject_process = (strip
                   | TextProc(emoji.demojize)
                   | ReSub(r':arrow_up:', 'â¬†ï¸')
                   | ReSub(r':arrow_down:', 'â¬‡ï¸')
                   | ReSub(r':heavy_plus_sign:', 'â•')
                   | ReSub(r':heavy_minus_sign:', 'â–')
                   | ReSub(r'^(:(\w+):)?\s*([^\n@]*)(@[a-z]+\s+)*$', r'\3')
                   | ucfirst | final_dot)

tag_filter_regexp = r'^v[0-9]+\.[0-9]+(\.[0-9]+)?$'
unreleased_version_label = '(unreleased)'
output_engine = mustache('./markdown.tpl')  # ĞŸÑƒÑ‚ÑŒ Ğº ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ñƒ
include_merge = True

OUTPUT_FILE = 'CHANGELOG.md'
release_title = r'\#\#\#\#\sRelease\snotes\sfor'
REV = r'v[0-9]+\.[0-9]+(\.[0-9]+)?'
DATE = r'\([0-9]+-[0-9]{2}-[0-9]{2}\)'
INSERT_POINT_REGEX = r"""(?isx)
^
(
  \s*%(release_title)s\s`\(%(label_unreleased)s\)`\s+%(date)s\s*(\n|\r\n|\r)
)?

(                                                              ## Match all between Release notes and release rev
    (
      (?!
         (?<=(\n|\r))                                          ## look back for newline
         %(release_title)s\s`(%(rev)s)`\s+%(date)s(\n|\r\n|\r) ## release with date
      )
      .
    )*
)?

(?P<tail>%(release_title)s\s`(?P<rev>%(rev)s)`\s+%(date)s)
""" % {
    'rev': REV,
    'date': DATE,
    'release_title': release_title,
    'label_unreleased': unreleased_version_label.strip('()'),
}

revs = [
    Caret(FileFirstRegexMatch(OUTPUT_FILE, INSERT_POINT_REGEX)),
    'HEAD',
]

publish = FileRegexSubst(OUTPUT_FILE, INSERT_POINT_REGEX, r'\2\o\g<tail>')
